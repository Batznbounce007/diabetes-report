name: Daily Diabetes Report

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/daily_report.yml"
      - "src/**"
      - "requirements.txt"
  schedule:
    - cron: "5 6 * * *" # 07:05 Europe/Berlin in winter; adjust if needed
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    env:
      NIGHTSCOUT_URL: ${{ secrets.NIGHTSCOUT_URL }}
      NIGHTSCOUT_API_SECRET: ${{ secrets.NIGHTSCOUT_API_SECRET }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TZ: ${{ secrets.TZ }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Validate required secrets
        run: |
          set -e
          missing=0
          for key in NIGHTSCOUT_URL NIGHTSCOUT_API_SECRET TELEGRAM_BOT_TOKEN TELEGRAM_CHAT_ID TZ; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required secret/env: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Warm up Nightscout endpoint
        run: |
          set -e
          for i in $(seq 1 12); do
            code="$(curl -sS -o /dev/null -w "%{http_code}" "$NIGHTSCOUT_URL/api/v1/status.json" || true)"
            echo "Attempt $i/12: status=$code"
            if [ "$code" = "200" ] || [ "$code" = "401" ] || [ "$code" = "403" ]; then
              exit 0
            fi
            sleep 10
          done
          echo "::error::Nightscout status endpoint is not reachable after retries"
          exit 1

      - name: Verify Nightscout API access
        run: |
          set -e
          api_hash="$(printf '%s' "$NIGHTSCOUT_API_SECRET" | sha1sum | awk '{print $1}')"
          code="$(curl -sS -o /tmp/ns_probe.json -w "%{http_code}" \
            -H "api-secret: $api_hash" \
            "$NIGHTSCOUT_URL/api/v1/entries.json?count=1" || true)"
          echo "Nightscout API probe status: $code"
          if [ "$code" != "200" ]; then
            echo "::error::Nightscout API probe failed (HTTP $code). Check NIGHTSCOUT_URL/NIGHTSCOUT_API_SECRET."
            head -c 400 /tmp/ns_probe.json || true
            echo
            exit 1
          fi

      - name: Verify Telegram bot and chat
        run: |
          set -e
          bot_code="$(curl -sS -o /tmp/tg_bot.json -w "%{http_code}" \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe" || true)"
          echo "Telegram bot probe status: $bot_code"
          if [ "$bot_code" != "200" ] || ! grep -q '"ok":true' /tmp/tg_bot.json; then
            echo "::error::Telegram bot token invalid. Check TELEGRAM_BOT_TOKEN."
            head -c 400 /tmp/tg_bot.json || true
            echo
            exit 1
          fi

          chat_code="$(curl -sS -G -o /tmp/tg_chat.json -w "%{http_code}" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getChat" || true)"
          echo "Telegram chat probe status: $chat_code"
          if [ "$chat_code" != "200" ] || ! grep -q '"ok":true' /tmp/tg_chat.json; then
            echo "::error::Telegram chat check failed. Check TELEGRAM_CHAT_ID and ensure you started the bot chat."
            head -c 400 /tmp/tg_chat.json || true
            echo
            exit 1
          fi

      - name: Run daily report
        run: |
          set -o pipefail
          python src/daily_report.py 2>&1 | tee /tmp/daily_report.log
          status="${PIPESTATUS[0]}"
          if [ "$status" -ne 0 ]; then
            last_line="$(tail -n 1 /tmp/daily_report.log | tr -d '\r')"
            echo "::error::daily_report.py failed: ${last_line}"
            exit "$status"
          fi
